input {
  beats {
    port => 5044
  }
}

filter {
  # Extraire le nom du fichier et la date
  grok {
    match => { 
      "[log][file][path]" => ".*[/\\](?<log_date>\d{4}-\d{2}-\d{2})[/\\](?<filename>\d+)_(?<file_timestamp>.+)\.txt$" 
    }
  }

  # Parser les métadonnées de build
  if [message] =~ /^builder:/ {
    grok {
      match => { "message" => "^builder: %{DATA:builder}$" }
      add_tag => ["header_builder"]
    }
  }
  else if [message] =~ /^slave:/ {
    grok {
      match => { "message" => "^slave: %{DATA:slave_name}$" }
      add_tag => ["header_slave"]
    }
  }
  else if [message] =~ /^starttime:/ {
    grok {
      match => { "message" => "^starttime: %{NUMBER:starttime}$" }
      add_tag => ["header_starttime"]
    }
    if [starttime] {
      date {
        match => ["starttime", "UNIX"]
        target => "build_starttime"
      }
    }
  }
  else if [message] =~ /^results:/ {
    grok {
      match => { "message" => "^results: %{DATA:build_result} \(%{NUMBER:result_code:int}\)$" }
      add_tag => ["header_result"]
    }
  }
  else if [message] =~ /^buildid:/ {
    grok {
      match => { "message" => "^buildid: %{DATA:build_id}$" }
      add_tag => ["header_buildid"]
    }
  }
  else if [message] =~ /^builduid:/ {
    grok {
      match => { "message" => "^builduid: %{DATA:build_uid}$" }
      add_tag => ["header_builduid"]
    }
  }
  else if [message] =~ /^revision:/ {
    grok {
      match => { "message" => "^revision: %{DATA:revision}$" }
      add_tag => ["header_revision"]
    }
  }
  
  # Parser les étapes de build (Started/Finished)
  else if [message] =~ /^========= (Started|Finished)/ {
    grok {
      match => { 
        "message" => "^========= %{WORD:step_status} %{DATA:step_name} \(results: %{NUMBER:step_result:int}, elapsed: %{NUMBER:elapsed_time:float} secs\)" 
      }
      add_tag => ["build_step"]
    }
  }
  
  # Détection des erreurs
  else if [message] =~ /(?i)(error|exception|failed|failure)/ {
    mutate {
      add_tag => ["error"]
    }
  }
  # Détection des warnings
  else if [message] =~ /(?i)(warning|warn)/ {
    mutate {
      add_tag => ["warning"]
    }
  }

  # Ajouter des métadonnées
  mutate {
    add_field => {
      "project" => "firefox"
      "log_type" => "build_log"
    }
  }

  # Détecter les anomalies simples
  if [result_code] and [result_code] != 0 {
    mutate {
      add_tag => ["anomaly", "non_zero_result"]
    }
  }

  if [elapsed_time] and [elapsed_time] > 300 {
    mutate {
      add_tag => ["long_step"]
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "firefox-logs-%{+YYYY.MM.dd}"
  }
  
  # Pour debug - peut être commenté en production
  stdout {
    codec => rubydebug {
      metadata => false
    }
  }
}